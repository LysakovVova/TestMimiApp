<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤—Å–µ–≥–æ —Ç–µ–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    body {
        font-family: sans-serif;
        /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¢–µ–ª–µ–≥—Ä–∞–º–∞. 
           –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ—Ç (–æ—Ç–∫—Ä—ã–ª–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ), –±—É–¥–µ—Ç –±–µ–ª—ã–π —Ñ–æ–Ω (#fff) */
        background-color: var(--tg-theme-bg-color, #fff);
        color: var(--tg-theme-text-color, #000); 
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤—Å—ë */
    }

    h2 {
        margin-top: 0;
    }

    /* –ö—Ä–∞—Å–∏–≤—ã–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ */
    input {
        box-sizing: border-box; /* –ß—Ç–æ–±—ã padding –Ω–µ –ª–æ–º–∞–ª —à–∏—Ä–∏–Ω—É */
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        font-size: 16px;
        border-radius: 10px; /* –ó–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
        border: 1px solid var(--tg-theme-hint-color, #ccc);
        
        /* –§–æ–Ω –ø–æ–ª—è –≤–≤–æ–¥–∞ —á—É—Ç—å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–æ–Ω–∞ */
        background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); 
        color: var(--tg-theme-text-color, #000);
        outline: none; /* –£–±–∏—Ä–∞–µ–º —Å–∏–Ω—é—é –æ–±–≤–æ–¥–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ */
    }

    /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
    input:focus {
        border-color: var(--tg-theme-button-color, #3390ec);
    }

    /* –ö—Ä–∞—Å–∏–≤–∞—è –∫–Ω–æ–ø–∫–∞ */
    button {
        width: 100%;
        padding: 14px;
        margin-top: 15px;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        
        /* –¶–≤–µ—Ç–∞ –∫–Ω–æ–ø–∫–∏ –∫–∞–∫ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ */
        background-color: var(--tg-theme-button-color, #3390ec);
        color: var(--tg-theme-button-text-color, #ffffff);
    }

    /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É */
    button:active {
        opacity: 0.8; /* –ß—É—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ –ø—Ä–∏ –∫–ª–∏–∫–µ */
    }

    /* –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
    #res {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
        width: 100%;
        text-align: center;
    }
</style>
</head>
<div id="giftModal" style="display:none; position:fixed; top:20%; left:10%; right:10%; background:#222; color:white; padding:20px; border-radius:15px; border: 2px solid gold; text-align:center; z-index:1000;">
    <h3>–ü–û–î–ê–†–û–ö!</h3>
    <p id="giftName">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    <button onclick="noAcceptGift()">–û–¢–ö–õ–û–ù–ò–¢–¨</button>
    <button onclick="acceptGift()">–ó–ê–ë–†–ê–¢–¨</button>
</div>

<body>

<button id="get_planet"> –°–ø–∏—Å–æ–∫ –ø–ª–∞–Ω–µ—Ç </button>

<button id="get_inventory">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
<button id="buy_items"> –ö—É–ø–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç </button>
<div id="res"></div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

async function loadProfile() {
  const r = await fetch("/api/auth", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ initData: tg.initData })
  });

  if (!r.ok) {
    document.getElementById("res").innerText = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: " + r.status;
    return;
  }

  const data = await r.json();
  // data –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å user_id –∏ –ª—é–±—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
  document.getElementById("res").innerText = `–±–∞–ª–∞–Ω—Å = ${data.balance}`;
}

loadProfile();

const API_INVENTORY = "/api/get_inventory";
const API_BUY_ITEM   = "/api/buy_item";

document.getElementById("buy_items").onclick = async () => { // –ü–æ–∫—É–ø–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç
  const out = document.getElementById("res");

  try {
    out.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    const r = await fetch(API_BUY_ITEM, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        user_id: tg.initDataUnsafe.user.id
      })
    });

    if (!r.ok) {
      throw new Error("HTTP " + r.status);
    }

    const data = await r.json();

    if (data.error) {
      out.innerText = "–û—à–∏–±–∫–∞: " + data.error;
      return;
    }

    if (data.result  === "success") {
      out.innerText = data.message // "–ü—Ä–µ–¥–º–µ—Ç —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω!";
    } else {
      out.innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç";
    }

  } catch (e) {
    console.error(e);
    out.innerText = "–û—à–∏–±–∫–∞";
  }
};

document.getElementById("get_inventory").onclick = async () => { // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
  const out = document.getElementById("res");

  try {
    out.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    const r = await fetch(API_INVENTORY, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        user_id: tg.initDataUnsafe.user.id
      })
    });

    if (!r.ok) {
      throw new Error("HTTP " + r.status);
    }

    const data = await r.json();

    if (data.error) {
      out.innerText = "–û—à–∏–±–∫–∞: " + data.error;
      return;
    }

    if (data.inventory && data.inventory.length > 0) {
      out.innerHTML = "<h2>–í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å:</h2><ul>" +
        data.inventory.map(item => `<li>${item.name} x${item.count}</li>`).join("") +
        "</ul>";
    } else {
      out.innerText = "–í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç";
    }

  } catch (e) {
    console.error(e);
    out.innerText = "–û—à–∏–±–∫–∞";
  }
};

// 1. –§—É–Ω–∫—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏—è (—Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ø–ª–∞–Ω–µ—Ç—É)
async function travelToPlanet(planetId, planetName) {
    const out = document.getElementById("res");
    
    // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è (–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç)
    if(!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –Ω–∞ –ø–ª–∞–Ω–µ—Ç—É ${planetName}?`)) return;

    try {
        const r = await fetch("/api/set_target_planet", { // <-- –ù–æ–≤—ã–π –∞–¥—Ä–µ—Å API –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                user_id: tg.initDataUnsafe.user.id,
                target_planet_id: planetId 
            })
        });

        const data = await r.json();
        alert(data.message); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–í—ã –ø—Ä–∏–±—ã–ª–∏!")
        
        // –¢—É—Ç –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        
    } catch (e) {
        console.error(e);
        alert("–û—à–∏–±–∫–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è");
    }
}

// 2. –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫"
document.getElementById("get_planet").onclick = async () => {
    const out = document.getElementById("res");

    try {
        out.innerText = "–°–∫–∞–Ω–∏—Ä—É–µ–º –∫–æ—Å–º–æ—Å...";

        const r = await fetch("/api/get_planets", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
        });

        if (!r.ok) throw new Error("HTTP " + r.status);

        const data = await r.json();

        if (data.error) {
            out.innerText = "–û—à–∏–±–∫–∞: " + data.error;
            return;
        }

        if (data.planets && data.planets.length > 0) {
            out.innerHTML = ""; // –û—á–∏—â–∞–µ–º –≤—ã–≤–æ–¥
            
            const title = document.createElement("h2");
            title.innerText = "–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–ª–∞–Ω–µ—Ç—ã:";
            out.appendChild(title);

            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫
            const listContainer = document.createElement("div");
            listContainer.style.display = "flex";
            listContainer.style.flexDirection = "column";
            listContainer.style.gap = "10px"; // –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏

            // –ü—Ä–æ–±–µ–≥–∞–µ–º—Å—è –ø–æ –∫–∞–∂–¥–æ–π –ø–ª–∞–Ω–µ—Ç–µ –∏ —Å–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É
            data.planets.forEach(planet => {
                const btn = document.createElement("button");
                
                // –¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ
                btn.innerText = `üöÄ ${planet.name} (${planet.coordinate_x}:${planet.coordinate_y})`;
                
                // –°—Ç–∏–ª–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã (–º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ CSS)
                btn.style.padding = "10px";
                btn.style.borderRadius = "8px";
                btn.style.border = "none";
                btn.style.background = "#4a90e2";
                btn.style.color = "white";
                btn.style.cursor = "pointer";

                // –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï: –í–µ—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞
                btn.onclick = () => travelToPlanet(planet.id, planet.name);

                listContainer.appendChild(btn);
            });

            out.appendChild(listContainer);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–µ–∫—Å—Ç–æ–º —Å–Ω–∏–∑—É
            const coords = document.createElement("p");
            coords.innerText = `–í—ã —Å–µ–π—á–∞—Å –∑–¥–µ—Å—å: (${data.user_coordinates.x}, ${data.user_coordinates.y})`;
            out.appendChild(coords);

        } else {
            out.innerText = "–ü–ª–∞–Ω–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
        }

    } catch (e) {
        console.error(e);
        out.innerText = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
    }
};

// –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
setInterval(checkGift, 3000);

async function checkGift() {
    // –ï—Å–ª–∏ –æ–∫–Ω–æ —É–∂–µ –≤–∏—Å–∏—Ç, –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä (–∂–¥–µ–º —Ä–µ–∞–∫—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞)
    try {
        const response = await fetch("/api/check_offer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
        });
        
        const data = await response.json();
        
        if (data.has_offer) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ!
            document.getElementById("giftName").innerText = data.name + (data.count > 1 ? ` x${data.count}` : ""); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            document.getElementById("giftModal").style.display = "block";
        }
    } catch (e) {
        console.log("–û—à–∏–±–∫–∞ –æ–ø—Ä–æ—Å–∞:", e);
    }
}

async function acceptGift() {
    // –Æ–∑–µ—Ä –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É
    const response = await fetch("/api/accept_offer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
    });
    
    // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
    document.getElementById("giftModal").style.display = "none";
}
async function noAcceptGift() {    
  const response = await fetch("/api/decline_offer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
    });
    // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
    document.getElementById("giftModal").style.display = "none";
}

</script>


</body>
</html>
