<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* Базовые настройки для всего тела страницы */
    body {
        font-family: sans-serif;
        /* Используем переменные Телеграма. 
           Если переменной нет (открыли в браузере), будет белый фон (#fff) */
        background-color: var(--tg-theme-bg-color, #fff);
        color: var(--tg-theme-text-color, #000); 
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center; /* Центрируем всё */
    }

    h2 {
        margin-top: 0;
    }

    /* Красивые поля ввода */
    input {
        box-sizing: border-box; /* Чтобы padding не ломал ширину */
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        font-size: 16px;
        border-radius: 10px; /* Закругленные углы */
        border: 1px solid var(--tg-theme-hint-color, #ccc);
        
        /* Фон поля ввода чуть отличается от основного фона */
        background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); 
        color: var(--tg-theme-text-color, #000);
        outline: none; /* Убираем синюю обводку при клике */
    }

    /* Поля ввода при нажатии */
    input:focus {
        border-color: var(--tg-theme-button-color, #3390ec);
    }

    /* Красивая кнопка */
    button {
        width: 100%;
        padding: 14px;
        margin-top: 15px;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        
        /* Цвета кнопки как в Телеграме */
        background-color: var(--tg-theme-button-color, #3390ec);
        color: var(--tg-theme-button-text-color, #ffffff);
    }

    /* Эффект нажатия на кнопку */
    button:active {
        opacity: 0.8; /* Чуть прозрачнее при клике */
    }

    /* Блок результата */
    #res {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
        width: 100%;
        text-align: center;
    }
</style>
</head>
<div id="giftModal" style="display:none; position:fixed; top:20%; left:10%; right:10%; background:#222; color:white; padding:20px; border-radius:15px; border: 2px solid gold; text-align:center; z-index:1000;">
    <h3>ПОДАРОК!</h3>
    <p id="giftName">Загрузка...</p>
    <button onclick="noAcceptGift()">ОТКЛОНИТЬ</button>
    <button onclick="acceptGift()">ЗАБРАТЬ</button>
</div>

<body>

<button id="get_planet"> Список планет 
</button>

<button id="get_inventory">Инвентарь</button>
<hr>
<button id="buy_items"> Купить предмет </button>"
<div id="res"></div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

async function loadProfile() {
  const r = await fetch("/api/auth", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ initData: tg.initData })
  });

  if (!r.ok) {
    document.getElementById("res").innerText = "Ошибка авторизации: " + r.status;
    return;
  }

  const data = await r.json();
  // data может содержать user_id и любые данные профиля
  document.getElementById("res").innerText = `баланс = ${data.balance}`;
}

loadProfile();

const API_INVENTORY = "/api/get_inventory";
const API_BUY_ITEM   = "/api/buy_item";

document.getElementById("buy_items").onclick = async () => { // Покупаем предмет
  const out = document.getElementById("res");

  try {
    out.innerText = "Загрузка...";

    const r = await fetch(API_BUY_ITEM, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        user_id: tg.initDataUnsafe.user.id
      })
    });

    if (!r.ok) {
      throw new Error("HTTP " + r.status);
    }

    const data = await r.json();

    if (data.error) {
      out.innerText = "Ошибка: " + data.error;
      return;
    }

    if (data.result  === "success") {
      out.innerText = data.message // "Предмет успешно куплен!";
    } else {
      out.innerText = "Не удалось купить предмет";
    }

  } catch (e) {
    console.error(e);
    out.innerText = "Ошибка";
  }
};

document.getElementById("get_inventory").onclick = async () => { // Получаем инвентарь
  const out = document.getElementById("res");

  try {
    out.innerText = "Загрузка...";

    const r = await fetch(API_INVENTORY, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        user_id: tg.initDataUnsafe.user.id
      })
    });

    if (!r.ok) {
      throw new Error("HTTP " + r.status);
    }

    const data = await r.json();

    if (data.error) {
      out.innerText = "Ошибка: " + data.error;
      return;
    }

    if (data.inventory && data.inventory.length > 0) {
      out.innerHTML = "<h2>Ваш инвентарь:</h2><ul>" +
        data.inventory.map(item => `<li>${item.name} x${item.count}</li>`).join("") +
        "</ul>";
    } else {
      out.innerText = "Ваш инвентарь пуст";
    }

  } catch (e) {
    console.error(e);
    out.innerText = "Ошибка";
  }
};

document.getElementById("get_planet").onclick = async () => { // Получаем список планет
  const out = document.getElementById("res");

  try {
    out.innerText = "Загрузка...";

    const r = await fetch("/api/get_planets", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        user_id: tg.initDataUnsafe.user.id
      })
    });

    if (!r.ok) {
      throw new Error("HTTP " + r.status);
    }

    const data = await r.json();

    if (data.error) {
      out.innerText = "Ошибка: " + data.error;
      return;
    }

    if (data.planets && data.planets.length > 0) {
      out.innerHTML = "<h2>Список планет:</h2><ul>" +
        data.planets.map(planet => `<li>${planet.name} (${planet.coordinate_x}, ${planet.coordinate_y})</li>`).join("") +
        "</ul>" + `<p>Ваши координаты: (${data.user_coordinates.x}, ${data.user_coordinates.y})</p>`;
    } else {
      out.innerText = "Планет не найдено";
    }

  } catch (e) {
    console.error(e);
    out.innerText = "Ошибка";
  }
};

// Функция, которая запускается каждые 3 секунды
setInterval(checkGift, 3000);

async function checkGift() {
    // Если окно уже висит, не спрашиваем сервер (ждем реакции игрока)

    try {
        const response = await fetch("/api/check_offer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
        });
        
        const data = await response.json();
        
        if (data.has_offer) {
            // Показываем окно!
            document.getElementById("giftName").innerText = data.name + (data.count > 1 ? ` x${data.count}` : ""); // Показываем название и количество
            document.getElementById("giftModal").style.display = "block";
        }
    } catch (e) {
        console.log("Ошибка опроса:", e);
    }
}

async function acceptGift() {
    // Юзер нажал кнопку
    const response = await fetch("/api/accept_offer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
    });
    
    // Скрываем окно
    document.getElementById("giftModal").style.display = "none";
}
async function noAcceptGift() {    
  const response = await fetch("/api/decline_offer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
    });
    // Скрываем окно
    document.getElementById("giftModal").style.display = "none";
}

</script>


</body>
</html>
